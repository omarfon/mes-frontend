<div class="space-y-5">
  <div class="ui-page-header">
    <div>
      <h3 class="ui-title">Seriales / Unidades</h3>
      <p class="ui-subtitle">Generación por lote, escaneo rápido, estado y ubicación por unidad.</p>
    </div>
  </div>

  <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
    <!-- Generación -->
    <div class="ui-surface p-5">
      <p class="text-sm font-semibold mb-3">Generar seriales</p>

      <div class="space-y-3">
        <div>
          <label class="ui-label">Lote</label>
          <input [(ngModel)]="lotCode" class="ui-input" placeholder="LOT-PT-0108" />
        </div>

        <div>
          <label class="ui-label">Prefijo (opcional)</label>
          <input [(ngModel)]="prefix" class="ui-input" placeholder="SER-PT-0108" />
 <p class="text-[11px] text-slate-500 mt-1">Si vacío: SER-{{ '{' }}LOTE-0001..</p>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="ui-label">Cantidad</label>
            <input type="number" min="1" [(ngModel)]="count" class="ui-input" />
          </div>

          <div>
            <label class="ui-label">Tipo unidad</label>
            <select [(ngModel)]="unitType" class="ui-select">
              <option value="BOBINA">Bobina</option>
              <option value="ROLLO">Rollo</option>
              <option value="CAJA">Caja</option>
              <option value="PALLET">Pallet</option>
              <option value="OTRO">Otro</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="ui-label">Qty por unidad</label>
            <input type="number" min="0" [(ngModel)]="qtyPerUnit" class="ui-input" />
          </div>
          <div>
            <label class="ui-label">Ubicación (opcional)</label>
            <input [(ngModel)]="genLocation" class="ui-input" placeholder="ALM-PT/R1/N1" />
          </div>
        </div>

        <button class="ui-btn-primary w-full" (click)="gen()">Generar</button>
      </div>
    </div>

    <!-- Escaneo -->
    <div class="ui-surface p-5 xl:col-span-2">
      <div class="flex items-center justify-between mb-3">
        <p class="text-sm font-semibold">Escaneo / Operación rápida</p>
        <span class="text-[11px] text-slate-500">Enter para cargar serial</span>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <div class="md:col-span-2">
          <label class="ui-label">Serial</label>
          <input [(ngModel)]="scan" (keydown.enter)="onScanEnter()" class="ui-input" placeholder="SER-LOT-...-0001" />
        </div>

        <div>
          <label class="ui-label">Acción</label>
          <select [(ngModel)]="action" class="ui-select">
            <option value="MOVE">Mover</option>
            <option value="BLOCK">Bloquear</option>
            <option value="QUARANTINE">Cuarentena</option>
            <option value="RELEASE">Liberar</option>
            <option value="NOTE">Nota</option>
          </select>
        </div>

        <div>
          <label class="ui-label">Destino (si mover)</label>
          <input [(ngModel)]="toLocation" class="ui-input" placeholder="ALM-..." />
        </div>

        <div class="md:col-span-4">
          <label class="ui-label">Nota / Motivo (opcional)</label>
          <input [(ngModel)]="note" class="ui-input" placeholder="Motivo / detalle..." />
        </div>

        <div class="md:col-span-4 flex gap-2 pt-1">
          <button class="ui-btn-ghost flex-1" (click)="resolve()">Cargar</button>
          <button class="ui-btn-primary flex-1" (click)="apply()">Aplicar</button>
        </div>
      </div>

      <div *ngIf="error" class="mt-3 rounded-xl border border-rose-500/30 bg-rose-500/10 p-3 text-sm text-rose-200">
        {{ error }}
      </div>
      <div *ngIf="success"
        class="mt-3 rounded-xl border border-emerald-500/30 bg-emerald-500/10 p-3 text-sm text-emerald-200">
        {{ success }}
      </div>

      <div *ngIf="selected" class="mt-4 rounded-2xl border border-slate-800/70 bg-slate-950/30 p-4">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-sm font-semibold">{{ selected.serial }}</div>
            <div class="text-xs text-slate-400 mt-1">{{ selected.unitType }} · {{ selected.itemCode }} · {{
              selected.lotCode }}</div>
          </div>
          <span [ngClass]="badge(selected.status)">{{ selected.status }}</span>
        </div>

        <div class="mt-3 text-xs text-slate-300">
          Qty: <b class="text-slate-100">{{ selected.qty }} {{ selected.uom }}</b> ·
          Ubicación: <b class="text-slate-100">{{ selected.location }}</b>
        </div>

        <div class="mt-3">
          <p class="text-xs font-semibold text-slate-200 mb-2">Últimos eventos</p>
          <div class="space-y-2">
            <div *ngFor="let ev of (selected.events | slice:0:5)"
              class="rounded-xl border border-slate-800/70 bg-slate-900/20 p-3">
              <div class="flex items-center justify-between">
                <div class="text-xs text-slate-300"><b class="text-slate-100">{{ ev.type }}</b> · {{ ev.by }}</div>
                <div class="text-[11px] text-slate-500">{{ ev.at }}</div>
              </div>
              <div *ngIf="ev.note" class="text-xs text-slate-300 mt-2">{{ ev.note }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div class="ui-surface p-5">
      <div class="flex items-center justify-between mb-4 gap-3">
        <div>
          <p class="text-sm font-semibold">Seriales</p>
          <p class="text-xs text-slate-400 mt-1">Búsqueda por serial, lote, ubicación, estado.</p>
        </div>
        <input [(ngModel)]="q" class="ui-input w-72" placeholder="Buscar..." />
      </div>

      <div class="ui-table-wrap">
        <table class="ui-table">
          <thead class="ui-thead">
            <tr>
              <th class="ui-th">Serial</th>
              <th class="ui-th">Lote</th>
              <th class="ui-th">Unidad</th>
              <th class="ui-th">Qty</th>
              <th class="ui-th">Ubicación</th>
              <th class="ui-th">Estado</th>
              <th class="ui-th w-32">Acción</th>
            </tr>
          </thead>

          <tbody class="bg-slate-950/20">
            <tr *ngFor="let s of list" class="ui-tr">
              <td class="ui-td">
                <div class="font-medium text-slate-100">{{ s.serial }}</div>
                <div class="text-xs text-slate-500 mt-1">{{ s.itemCode }}</div>
              </td>
              <td class="ui-td">{{ s.lotCode }}</td>
              <td class="ui-td">{{ s.unitType }}</td>
              <td class="ui-td">{{ s.qty }} {{ s.uom }}</td>
              <td class="ui-td">{{ s.location }}</td>
              <td class="ui-td"><span [ngClass]="badge(s.status)">{{ s.status }}</span></td>
              <td class="ui-td">
                <button class="ui-btn-ghost text-xs" (click)="open(s)">Ver</button>
              </td>
            </tr>

            <tr *ngIf="list.length === 0">
              <td colspan="7" class="px-4 py-10 text-center text-slate-500">No hay seriales aún.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>